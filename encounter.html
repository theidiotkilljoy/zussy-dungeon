<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encounter — Skeleton</title>
<style>
  :root{
    --bg:#0a0b10; --text:#e8ecf1; --floor:#0f1320;
    --stone:#1b1f2b; --stone2:#242b3a; --ok:#7cffb8; --warn:#ffb86b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(1200px 800px at 50% 0, #121622 0, #0a0b10 70%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
    color:var(--text); font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }

  /* Header + stage + HUD rows */
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto;gap:8px}

  header{display:grid;place-items:center;padding-top:8px}
  h1{margin:0;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3.8vw,32px)}

  .stage{display:grid;place-items:center;padding:8px 12px}
  .scaleBox{transform-origin:top center}

  /* Fixed logical playfield */
  #arena{position:relative;width:960px;height:540px;background:var(--floor);
    border:1px solid #222a3b;border-radius:14px;overflow:hidden}
  #arena::after{content:"";position:absolute;inset:0;pointer-events:none;
    background:radial-gradient(120% 100% at 50% 0, rgba(0,0,0,.15), rgba(0,0,0,.45));
    mix-blend-mode:multiply;opacity:.45}

  .ground{position:absolute;left:0;right:0;bottom:112px;height:4px;
    background:linear-gradient(90deg,#1a2030,#2a334a 50%,#1a2030);opacity:.35}

  /* Door on the right (keep these numbers in sync with JS constants below) */
  .door{position:absolute;width:40px;height:84px;right:26px;bottom:112px;
    border:2px solid #313a52;border-radius:8px;background:#131824}
  .door::after{content:"";position:absolute;width:6px;height:6px;right:8px;top:50%;
    transform:translateY(-50%);background:#9aa3b2;border-radius:50%}

  /* Player & enemy */
  #player{position:absolute;width:56px;height:56px;object-fit:contain;image-rendering:pixelated;pointer-events:none}
  #enemyWrap{position:absolute;width:68px;height:68px;cursor:pointer}
  #enemy{width:100%;height:100%;object-fit:contain;image-rendering:pixelated;display:block}

  /* Drop item (coffee) */
  #dropCoffee{
    position:absolute; display:none; image-rendering:pixelated; pointer-events:none;
    z-index:5; /* above ground and enemy */
    transition: left .35s ease-in, top .35s ease-in, transform .35s ease-in;
  }

  /* Animations */
  @keyframes startleY { 0%,100%{transform:translateY(0)} 20%{transform:translateY(-8px)} 40%{transform:translateY(6px)} 60%{transform:translateY(-5px)} 80%{transform:translateY(3px)} }
  @keyframes paceX    { from{transform:translateX(-6px)} to{transform:translateX(6px)} }
  @keyframes shakeY   { 0%,100%{transform:translateY(0)} 25%{transform:translateY(-4px)} 50%{transform:translateY(3px)} 75%{transform:translateY(-2px)} }
  .startle { animation: startleY .55s ease-out }
  .pace    { animation: paceX 1.6s ease-in-out .2s infinite alternate }
  .shake   { animation: shakeY .45s ease-in-out }
  .dead    { transition:transform .5s ease-out; transform:rotate(90deg); transform-origin:50% 50% }

  .hud{margin:0 0 10px;opacity:.95;font-size:14px;text-align:center}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #313a52;border-radius:999px;margin:0 4px}
  .counter{display:inline-block;margin-left:10px;padding:4px 8px;border:1px solid #3a435c;border-radius:8px}

  .toast{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);
    padding:8px 12px;border:1px solid #3a435c;border-radius:10px;font-size:14px;background:#0b0f1a;opacity:.95}
  .hidden{display:none}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Kill the Enemy!</h1></header>

  <div class="stage">
    <div id="scale" class="scaleBox">
      <div id="arena" aria-label="Skeleton encounter battlefield">
        <div class="ground" aria-hidden="true"></div>

        <!-- Door -->
        <div id="door" class="door" title="Exit"></div>

        <!-- Player -->
        <img id="player" src="assets/img/zussy2.png" alt="Knight">

        <!-- Enemy -->
        <div id="enemyWrap" class="startle">
          <img id="enemy" src="assets/img/skeleton.png" alt="Skeleton">
        </div>

        <!-- Loot drop -->
        <img id="dropCoffee" src="assets/img/coffee.png" alt="Magic dark elixir">

        <div id="toast" class="toast hidden"></div>
      </div>
    </div>
  </div>

  <div class="hud">
    <span class="pill">WASD</span> or <span class="pill">Arrows</span> to move.
    <span class="pill">Click on the enemy to attack.</span>
    <span id="hits" class="counter">Hits left: <strong>5</strong></span>
  </div>
</div>

<script>
(function(){
  const NEXT_URL = 'cats.html'; // where the door leads

  // Logical stage
  const W = 960, H = 540;
  const GROUND_BOTTOM = 112;
  const GROUND_Y = H - GROUND_BOTTOM;

  // Door constants mirrored from CSS
  const DOOR_W = 40, DOOR_H = 84, DOOR_RIGHT = 26, DOOR_BOTTOM = GROUND_BOTTOM;

  // Entities (fixed sizes mirrored from CSS)
  const enemyW = 68, enemyH = 68;
  const playerW = 56, playerH = 56;

  // Positions
  const enemyX  = 700, enemyY = GROUND_Y - enemyH; // faces left
  const playerStartX = 36, playerStartY = GROUND_Y - playerH;

  // DOM
  const scaleBox = document.getElementById('scale');
  const playerEl = document.getElementById('player');
  const enemyWrap= document.getElementById('enemyWrap');
  const enemyImg = document.getElementById('enemy');
  const hitsEl   = document.getElementById('hits').querySelector('strong');
  const doorEl   = document.getElementById('door');
  const toastEl  = document.getElementById('toast');
  const coffeeEl = document.getElementById('dropCoffee');

  // Place elements explicitly
  let player = { x: playerStartX, y: playerStartY, w: playerW, h: playerH };
  place(playerEl, player);
  enemyWrap.style.left = enemyX + 'px';
  enemyWrap.style.top  = enemyY + 'px';

  // State
  let enemyAlive = true;
  let hitsLeft = 5;
  hitsEl.textContent = hitsLeft;

  // Coffee drop state
  const coffeeSize = Math.round(enemyH * 0.25);   // ~1/4 skeleton
  let coffee = { active:false, sucked:false, x:0, y:0, w:coffeeSize, h:coffeeSize, vx:0, vy:0, bounces:0 };

  // After startle, begin pacing
  enemyWrap.addEventListener('animationend', (e)=>{
    if(e.animationName === 'startleY'){
      enemyWrap.classList.remove('startle');
      enemyWrap.classList.add('pace');
    }
  });

  // Responsive scale
  function fit(){
    const maxW = Math.min(window.innerWidth*0.96, 1200);
    const maxH = window.innerHeight - 120;
    const s = Math.min(maxW/W, maxH/H);
    scaleBox.style.transform = `scale(${s})`;
  }
  window.addEventListener('resize', fit); fit();

  // Input
  const keys = {w:false,a:false,s:false,d:false,ArrowUp:false,ArrowLeft:false,ArrowDown:false,ArrowRight:false};
  addEventListener('keydown', e=>{ if(keys.hasOwnProperty(e.key)){ keys[e.key]=true; e.preventDefault(); }},{passive:false});
  addEventListener('keyup',   e=>{ if(keys.hasOwnProperty(e.key)){ keys[e.key]=false; e.preventDefault(); }},{passive:false});

  // Helpers
  const speed = 2.8;
  function place(el, r){ el.style.left = r.x + 'px'; el.style.top = r.y + 'px'; }
  function rect(x,y,w,h){ return {x,y,w,h}; }
  function intersects(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
  function rectDistance(a,b){
    const dx = Math.max(b.x - (a.x + a.w), a.x - (b.x + b.w), 0);
    const dy = Math.max(b.y - (a.y + a.h), a.y - (b.y + b.h), 0);
    return Math.hypot(dx,dy);
  }
  function enemyRect(){ return rect(enemyX, enemyY, enemyW, enemyH); }
  function doorRect(){
    const left = W - DOOR_RIGHT - DOOR_W;
    const top  = H - DOOR_BOTTOM - DOOR_H;
    return rect(left, top, DOOR_W, DOOR_H);
  }
  const bounds = rect(0,0,W,H);
  function clampToBounds(e){
    e.x = Math.max(0, Math.min(e.x, bounds.w - e.w));
    e.y = Math.max(0, Math.min(e.y, bounds.h - e.h));
  }

  // Movement with collision against enemy while alive
  function movePlayer(dx, dy){
    // X
    player.x += dx;
    clampToBounds(player);
    if(enemyAlive && intersects(player, enemyRect())){
      if(dx > 0) player.x = enemyRect().x - player.w;
      else if(dx < 0) player.x = enemyRect().x + enemyRect().w;
    }
    // Y
    player.y += dy;
    clampToBounds(player);
    if(enemyAlive && intersects(player, enemyRect())){
      if(dy > 0) player.y = enemyRect().y - player.h;
      else if(dy < 0) player.y = enemyRect().y + enemyRect().h;
    }
    place(playerEl, player);
  }

  // Toast (supports sticky)
  let toastTimer;
  function toast(msg, {sticky=false, cls=''} = {}){
    toastEl.className = `toast ${cls}`.trim();
    toastEl.textContent = msg;
    toastEl.classList.remove('hidden');
    clearTimeout(toastTimer);
    if(!sticky){
      toastTimer = setTimeout(()=> toastEl.classList.add('hidden'), 1100);
    }
  }

  // Combat
  let cooling = false;
  function canHit(){ return rectDistance(player, enemyRect()) <= 4; }
  function hitEnemy(){
    if(!enemyAlive) return;
    if(!canHit()){ toast('Move closer…', {cls:'warn'}); return; }
    if(cooling) return;
    cooling = true;

    enemyImg.src = 'assets/img/skeleton.gif';
    setTimeout(()=>{
      hitsLeft--;
      hitsEl.textContent = hitsLeft;
      if(hitsLeft > 0){
        enemyImg.src = 'assets/img/skeleton.png';
        cooling = false;
      }else{
        enemyImg.src = 'assets/img/skeleton.png';
        enemyWrap.classList.remove('pace');
        enemyWrap.classList.add('shake');
        setTimeout(()=>{
          enemyWrap.classList.remove('shake');
          enemyWrap.classList.add('dead');
          enemyAlive = false;                   // no longer blocks movement
          toast('The skeleton is defeated!', {sticky:true, cls:'ok'});

          // Spawn loot right as the corpse falls
          spawnCoffeeDrop();

          cooling = false;
        }, 460);
      }
    }, 520);
  }
  enemyWrap.addEventListener('click', hitEnemy);
  enemyImg.addEventListener('click', hitEnemy);

  // ----- Coffee drop logic -----
  function spawnCoffeeDrop(){
    // Starting position: near the skeleton center
    coffee.x = Math.round(enemyX + enemyW/2 - coffee.w/2);
    coffee.y = Math.round(enemyY + enemyH*0.25);
    coffee.vx = 2.6;           // to the right
    coffee.vy = -6.2;          // upward pop
    coffee.bounces = 0;
    coffee.active = true;
    coffee.sucked = false;

    coffeeEl.style.width = coffee.w + 'px';
    coffeeEl.style.height = 'auto';
    coffeeEl.style.left = coffee.x + 'px';
    coffeeEl.style.top  = coffee.y + 'px';
    coffeeEl.style.transform = 'scale(1)';
    coffeeEl.style.display = 'block';
  }

  function startSuction(){
    if(coffee.sucked) return;
    coffee.sucked = true;

    // Target: player's center
    const tx = player.x + player.w/2 - coffee.w/2;
    const ty = player.y + player.h/2 - coffee.h/2;

    // Use CSS transition to fly + shrink
    coffeeEl.style.transition = 'left .35s ease-in, top .35s ease-in, transform .35s ease-in';
    coffeeEl.style.left = tx + 'px';
    coffeeEl.style.top  = ty + 'px';
    coffeeEl.style.transform = 'scale(0.15)';

    coffeeEl.addEventListener('transitionend', ()=>{
      coffeeEl.style.display = 'none';
      toast('A magic dark elixir has been added to your inventory', {sticky:true, cls:'ok'});
    }, {once:true});
  }

  // Main loop
  function tick(){
    let dx=0, dy=0;
    if(keys.w || keys.ArrowUp) dy -= speed;
    if(keys.s || keys.ArrowDown) dy += speed;
    if(keys.a || keys.ArrowLeft) dx -= speed;
    if(keys.d || keys.ArrowRight) dx += speed;

    if(dx || dy) movePlayer(dx, dy);

    // Coffee physics (simple)
    if(coffee.active && !coffee.sucked){
      // gravity
      coffee.vy += 0.35;
      coffee.x += coffee.vx;
      coffee.y += coffee.vy;

      // floor collision/bounce
      const floorY = GROUND_Y - coffee.h;
      if(coffee.y >= floorY && coffee.vy > 0){
        coffee.y = floorY;
        coffee.vy = -Math.abs(coffee.vy) * 0.55; // bounce up
        coffee.vx *= 0.8;                        // friction
        coffee.bounces++;
        // After first bounce, schedule suction shortly after a brief settle
        if(coffee.bounces === 1){
          setTimeout(startSuction, 300);
        }
      }

      // place
      coffeeEl.style.left = Math.round(coffee.x) + 'px';
      coffeeEl.style.top  = Math.round(coffee.y) + 'px';
    }

    // Exit if enemy dead and player overlaps door
    if(!enemyAlive && intersects(player, doorRect())){
      window.location.href = NEXT_URL;
      return;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Utilities
  function doorRect(){
    const left = W - DOOR_RIGHT - DOOR_W;
    const top  = H - DOOR_BOTTOM - DOOR_H;
    return rect(left, top, DOOR_W, DOOR_H);
  }
})();
</script>
</body>
</html>
