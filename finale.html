<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finale â€” Birthday Room</title>
<link rel="preload" as="audio" href="assets/audio/fallen.mp3" type="audio/mpeg">
<style>
  :root{
    --text:#e8ecf1; --bg:#0a0b10;
    --msgBg:rgba(0,0,0,.55); --msgBorder:#3a435c;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(1200px 800px at 50% 0, #121622 0, #0a0b10 70%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    overflow:hidden;
  }

  .stage{display:grid;place-items:center;height:100dvh;padding:10px}
  #scale { transform-origin:top center }

  /* Fixed viewport */
  #scene{
    position:relative; width:960px; height:540px;
    border:1px solid #222a3b; border-radius:14px; overflow:hidden;
    background:#0f1320 center/cover no-repeat;
    background-image:url("assets/img/room.png");
  }
  #scene::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:radial-gradient(120% 100% at 50% 0, rgba(0,0,0,.15), rgba(0,0,0,.45));
    mix-blend-mode:multiply; opacity:.45;
  }

  /* Top message */
  #message{
    position:absolute; left:12px; right:12px; top:12px;
    padding:10px 14px; text-align:center;
    background:var(--msgBg); border:1px solid var(--msgBorder); border-radius:10px;
    font-weight:800; letter-spacing:.2px;
    backdrop-filter: blur(2px);
    user-select:none;
    pointer-events:none;     /* party: don't block cake clicks */
    z-index:20;
  }
  #message.clickable{
    pointer-events:auto;     /* enabled for Death + stinger */
    cursor:pointer;
  }

  /* Row of sprites */
  .row{
    position:absolute; left:0; right:0; bottom:48px;
    display:flex; justify-content:center; align-items:flex-end;
    gap:26px; pointer-events:none;
    z-index:15;
  }
  .row.tight{ gap:0; }                  /* almost no spacing before cake */

  .sprite{
    height:192px;                       /* +60% size */
    width:auto; image-rendering:pixelated; display:block;
    pointer-events:auto;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,.45));
  }

  /* Per-sprite adjustments */
  #artie{
    position:relative;
    top:-96px;
    left:-80px;
  }
  .row.party #zussy    { transform: translateX(-50%); }
  .row.party #cakemaia { transform: translateX(-50%); }

  /* Knife-Maia overlay for the stinger */
  #knifeMaia{
    position:absolute; left:0; top:0;
    height:192px; width:auto; image-rendering:pixelated;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,.45));
    z-index:25; display:none; pointer-events:none;
  }

  /* Blackout used earlier */
  #flash{ position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:30; }
  @keyframes blackout { 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
  .flash { animation:blackout .55s ease forwards }

  /* --- Soul-burst transition pieces (centered on Death) --- */
  /* Quick white flash */
  #flashWhite{ position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:35; }
  @keyframes flashQuick { 0%{opacity:0} 25%{opacity:1} 100%{opacity:0} }
  .flashQuick { animation: flashQuick .12s ease-out forwards; }

  /* Radial burst anchored at Death */
  #soul{
    position:absolute; left:50%; top:50%;
    width:64px; height:64px; pointer-events:none; z-index:34; opacity:0;
    transform:translate(-50%,-50%) scale(0.05);
    background:
      radial-gradient(circle,
        rgba(255,255,255,.95) 0 22%,
        rgba(255,255,255,.65) 22% 36%,
        rgba(255,255,255,.18) 36% 60%,
        rgba(255,255,255,0) 60% 100%);
    filter: blur(0.5px);
    border-radius:50%;
  }
  @keyframes soulBurst {
    0%   { opacity:0; transform:translate(-50%,-50%) scale(0.05) }
    5%   { opacity:1; }
    100% { opacity:0; transform:translate(-50%,-50%) scale(8) }
  }
  .burst { animation: soulBurst .55s ease-out forwards; }
</style>
</head>
<body>
<div class="stage">
  <div id="scale">
    <div id="scene" aria-label="Birthday celebration room">
      <div id="message">Happy Birthday Zachary! Make a wish and blow out your candle</div>

      <!-- Party cast (tight spacing) + 'party' behavior for shifted Zussy/Maia -->
      <div id="row" class="row tight party">
        <img id="jiji"      class="sprite" src="assets/img/jiji.png"      alt="Jiji">
        <img id="minnie"    class="sprite" src="assets/img/minnie.png"    alt="Minnie">
        <img id="zussy"     class="sprite" src="assets/img/zussy2.png"    alt="Zachary">
        <img id="cakemaia"  class="sprite" src="assets/img/cakemaia.png"  alt="Maia with cake">
        <img id="artie"     class="sprite" src="assets/img/artie.png"     alt="Artie">
      </div>

      <!-- Stinger overlay (hidden until used) -->
      <img id="knifeMaia" src="assets/img/knifemaia.png" alt="Maia strikes">

      <!-- Transition overlays -->
      <div id="soul"></div>
      <div id="flashWhite"></div>
      <div id="flash"></div>
    </div>
  </div>
</div>

<!-- Background music -->
<audio id="bgm" src="assets/audio/fallen.mp3" loop preload="auto"></audio>

<script>
(function(){
  const W=960, H=540;
  const scaleBox = document.getElementById('scale');
  function fit(){
    const maxW = Math.min(window.innerWidth*0.96, 1200);
    const maxH = window.innerHeight*0.94;
    const s = Math.min(maxW/W, maxH/H);
    scaleBox.style.transform = `scale(${s})`;
  }
  addEventListener('resize', fit); fit();

  const scene = document.getElementById('scene');
  const msg   = document.getElementById('message');
  const row   = document.getElementById('row');
  const flash = document.getElementById('flash');          // black
  const flashWhite = document.getElementById('flashWhite'); // white
  const soul  = document.getElementById('soul');
  const cake  = document.getElementById('cakemaia');
  const knife = document.getElementById('knifeMaia');

  /* BGM: start on first gesture */
  const bgm = document.getElementById('bgm');
  if (bgm){
    bgm.volume = 0.45;
    const boot = () => { bgm.play().catch(()=>{}); window.removeEventListener('pointerdown', boot); window.removeEventListener('keydown', boot); };
    window.addEventListener('pointerdown', boot, {once:true});
    window.addEventListener('keydown', boot, {once:true});
  }

  const DEATH_LINES = [
    "Oh, don't worry",
    "I'm not here for you *just* yet",
    "But live every day thoughtfully, because you never know when..."
  ];
  let step = 0;
  let phase = 'party'; // 'party' -> 'death' -> 'stinger' -> 'final'

  // Party: click cake to go dark
  cake.addEventListener('click', () => {
    if (phase !== 'party') return;
    flash.classList.add('flash'); // blackout effect

    setTimeout(()=>{
      scene.style.backgroundImage = 'url("assets/img/darkroom.png")';

      // Switch to death scene; regular spacing for two sprites
      row.classList.remove('tight','party');
      row.innerHTML = `
        <img id="zussy" class="sprite" src="assets/img/zussy2.png" alt="Zachary">
        <img id="death" class="sprite" src="assets/img/death.png"  alt="Death">
      `;

      phase = 'death';
      step = 0;
      msg.textContent = `Death: ${DEATH_LINES[step]}`;
      msg.classList.add('clickable');

      // click advances through Death lines, then triggers stinger
      msg.onclick = () => {
        if (phase === 'death') {
          step++;
          if (step < DEATH_LINES.length) {
            msg.textContent = `Death: ${DEATH_LINES[step]}`;
          } else {
            // STINGER: overlay knifemaia slightly to the right of Death,
            // then nudge up/left by half of knife's own size for alignment
            phase = 'stinger';
            const deathEl = document.getElementById('death');
            const rDeath = deathEl.getBoundingClientRect();
            const rScene = scene.getBoundingClientRect();

            knife.style.display = 'block';
            knife.style.left = (rDeath.left - rScene.left + 70) + 'px';
            knife.style.top  = (rDeath.top  - rScene.top) + 'px';

            // after it's rendered, offset by half its own dimensions
            requestAnimationFrame(()=>{
              const rKnife = knife.getBoundingClientRect();
              const x = (rDeath.left - rScene.left) + 70 - (rKnife.width  / 2);
              const y = (rDeath.top  - rScene.top)          - (rKnife.height / 2);
              knife.style.left = x + 'px';
              knife.style.top  = y + 'px';
            });

            msg.textContent = "Maia: Zussy's done when I say he's done!";
          }
        } else if (phase === 'stinger') {
          // === Radial Soul-Burst Transition (centered on Death) ===
          const deathEl = document.getElementById('death');
          const rDeath = deathEl.getBoundingClientRect();
          const rScene = scene.getBoundingClientRect();
          const cx = rDeath.left - rScene.left + rDeath.width/2;
          const cy = rDeath.top  - rScene.top  + rDeath.height/2;

          soul.style.left = cx + 'px';
          soul.style.top  = cy + 'px';
          soul.classList.remove('burst');
          void soul.offsetWidth;
          soul.classList.add('burst');

          flashWhite.classList.remove('flashQuick');
          void flashWhite.offsetWidth;
          flashWhite.classList.add('flashQuick');

          // when the soul burst ends, return to party
          const onEnd = () => {
            soul.removeEventListener('animationend', onEnd);
            knife.style.display = 'none';
            scene.style.backgroundImage = 'url("assets/img/room.png")';
            row.className = 'row tight party';
            row.innerHTML = `
              <img id="jiji"      class="sprite" src="assets/img/jiji.png"      alt="Jiji">
              <img id="minnie"    class="sprite" src="assets/img/minnie.png"    alt="Minnie">
              <img id="zussy"     class="sprite" src="assets/img/zussy2.png"    alt="Zachary">
              <img id="cakemaia"  class="sprite" src="assets/img/cakemaia.png"  alt="Maia with cake">
              <img id="artie"     class="sprite" src="assets/img/artie.png"     alt="Artie">
            `;
            msg.textContent = "Happy Birthday, I love you forever perfect boyfriend";
            msg.classList.remove('clickable');
            msg.onclick = null;
            phase = 'final';
          };
          soul.addEventListener('animationend', onEnd, { once:true });
        }
      };

    }, 110);

    flash.addEventListener('animationend', () => {
      flash.classList.remove('flash');
    }, { once:true });
  }, { passive:true });
})();
</script>
</body>
</html>
