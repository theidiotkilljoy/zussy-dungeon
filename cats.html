<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Room of Love and Piss</title>
<style>
  :root{
    --bg:#0a0b10; --text:#e8ecf1; --floor:#0f1320;
    --stone:#1b1f2b; --stone2:#242b3a; --ok:#7cffb8; --warn:#ffb86b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(1200px 800px at 50% 0, #121622 0, #0a0b10 70%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
    color:var(--text); font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }

  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
  header{display:grid;place-items:center;padding-top:8px}
  h1{margin:0;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3.8vw,32px)}

  .stage{display:grid;place-items:center;padding:8px 12px}
  .scaleBox{transform-origin:top center}

  /* Playfield */
  #room{position:relative;width:960px;height:540px;background:var(--floor);
    border:1px solid #222a3b;border-radius:14px;overflow:hidden}
  #room::after{content:"";position:absolute;inset:0;pointer-events:none;
    background:radial-gradient(120% 100% at 50% 0, rgba(0,0,0,.15), rgba(0,0,0,.45));
    mix-blend-mode:multiply;opacity:.45}
  .ground{position:absolute;left:0;right:0;bottom:112px;height:4px;
    background:linear-gradient(90deg,#1a2030,#2a334a 50%,#1a2030);opacity:.35}

  /* Door (right side) */
  .door{position:absolute;width:40px;height:84px;right:26px;bottom:112px;
    border:2px solid #313a52;border-radius:8px;background:#131824;cursor:pointer}
  .door::after{content:"";position:absolute;width:6px;height:6px;right:8px;top:50%;
    transform:translateY(-50%);background:#9aa3b2;border-radius:50%}

  /* Cats row (L→R) */
  .cat{position:absolute;width:96px;height:96px;object-fit:contain;image-rendering:pixelated;cursor:pointer}
  #minnie{left:240px; bottom:112px}
  #jiji  {left:432px; bottom:112px}
  #artie {left:624px; bottom:112px}

  /* Player (manual control) */
  #player{position:absolute;width:56px;height:56px;object-fit:contain;image-rendering:pixelated;pointer-events:none}

  /* Heart (36x36), floats straight up from player top edge */
  .heart{position:absolute;width:36px;height:36px;object-fit:contain;image-rendering:pixelated;
    pointer-events:none; opacity:0; z-index:5}
  @keyframes floatUp {
    0%   { transform:translateY(0);    opacity:1 }
    100% { transform:translateY(-28px); opacity:0 }
  }
  .float{ animation: floatUp 1.8s ease-out forwards }

  /* HUD + log */
  .hud{margin-top:10px;opacity:.95;font-size:14px;text-align:center}
  .pill{display:inline-block;padding:6px 10px;border:1px solid #313a52;border-radius:999px;margin:0 4px}
  .log{
    width:min(960px,96vw); margin:10px auto 18px; padding:10px 12px;
    border:1px solid #3a435c; border-radius:10px; background:#0b0f1a; opacity:.95; text-align:left;
    font-size:14px; line-height:1.45; white-space:pre-line;
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>This Room Smells like Love and Cat Piss <3</h1></header>

  <div class="stage">
    <div id="scale" class="scaleBox">
      <div id="room" aria-label="Cat room — pet all three">
        <div class="ground" aria-hidden="true"></div>

        <!-- Door (auto-opens when reached after all petted) -->
        <div id="door" class="door" title="Exit to next room"></div>

        <!-- Cats (L→R: Minnie, Jiji, Artie) -->
        <img id="minnie" class="cat" src="assets/img/minnie.png" alt="Minnie the cat">
        <img id="jiji"   class="cat" src="assets/img/jiji.png"   alt="Jiji the cat">
        <img id="artie"  class="cat" src="assets/img/artie.png"  alt="Artie the cat">

        <!-- Player -->
        <img id="player" src="assets/img/knight2.png" alt="Knight">

        <!-- Heart template (cloned per pet) -->
        <img id="heart-tmpl" class="heart" src="assets/img/heart.png" alt="" aria-hidden="true">
      </div>
    </div>

    <div class="hud">
      <span class="pill">WASD</span> or <span class="pill">Arrows</span> to move.
      <span class="pill">You must pet all three to pass.</span>
    </div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
(function(){
  const NEXT_URL = 'riddle.html'; // next page

  // --- Scaling ---
  const scaleBox = document.getElementById('scale');
  const W=960, H=540;
  let SCALE = 1; // keep actual scale so we can convert viewport px -> logical px
  function fit(){
    const maxW = Math.min(window.innerWidth*0.96, 1200);
    const maxH = window.innerHeight - 160;
    SCALE = Math.min(maxW/W, maxH/H);
    scaleBox.style.transform = `scale(${SCALE})`;
  }
  window.addEventListener('resize', fit); fit();

  // --- DOM & State ---
  const room = document.getElementById('room');
  const door = document.getElementById('door');
  const logEl = document.getElementById('log');
  const playerEl = document.getElementById('player');

  const cats = [
    { id:'minnie', msg:'Angel baby Minnie loves you so so much.' },
    { id:'jiji',   msg:'Jiji is grateful for your special nap time cuddles.' },
    { id:'artie',  msg:'Artie wants you to have the best birthday ever and forgives all the torture you\'ve inflicted on him.' }
  ];
  const petted = new Set();

  // --- Player (manual movement) ---
  const groundY = H - 112;
  const player = { x: 36, y: groundY - 56, w:56, h:56 };
  place(playerEl, player);

  const keys = {w:false,a:false,s:false,d:false,ArrowUp:false,ArrowLeft:false,ArrowDown:false,ArrowRight:false};
  addEventListener('keydown', e=>{ if(keys.hasOwnProperty(e.key)){ keys[e.key]=true; e.preventDefault(); } }, {passive:false});
  addEventListener('keyup',   e=>{ if(keys.hasOwnProperty(e.key)){ keys[e.key]=false; e.preventDefault(); } }, {passive:false});
  const speed = 2.4;
  function movePlayer(dx,dy){
    player.x = Math.max(0, Math.min(W - player.w, player.x + dx));
    player.y = Math.max(0, Math.min(H - player.h, player.y + dy));
    place(playerEl, player);
  }
  function place(el, r){ el.style.left = r.x + 'px'; el.style.top = r.y + 'px'; }

  // --- Geometry helpers (explicit door rect so we don't parse CSS) ---
  function rect(x,y,w,h){ return {x,y,w,h}; }
  function intersects(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
  const DOOR_W=40, DOOR_H=84, DOOR_RIGHT=26, DOOR_BOTTOM=112;
  function doorRect(){
    const left = W - DOOR_RIGHT - DOOR_W;
    const top  = H - DOOR_BOTTOM - DOOR_H;
    return rect(left, top, DOOR_W, DOOR_H);
  }

  // --- UI helpers ---
  function appendMsg(text){
    const line = document.createElement('div');
    line.textContent = '• ' + text;
    logEl.appendChild(line);
  }

  // Heart directly above player's head (flush), slightly raised so it's just above
  function popHeartOverPlayer(){
    const roomRect = room.getBoundingClientRect();
    const pRect    = playerEl.getBoundingClientRect();

    const HEART_W = 36, HEART_H = 36;
    const HEAD_OFFSET = 2; // barely above the head

    // convert from viewport px to logical px using SCALE
    const leftLogical = ((pRect.left - roomRect.left) / SCALE) + (player.w - HEART_W)/2;
    const topLogical  = ((pRect.top  - roomRect.top)  / SCALE) - HEART_H - HEAD_OFFSET;

    const heart = document.getElementById('heart-tmpl').cloneNode(true);
    heart.id = '';
    heart.style.left = leftLogical + 'px';
    heart.style.top  = topLogical  + 'px';

    room.appendChild(heart);
    requestAnimationFrame(()=> heart.classList.add('float'));
    setTimeout(()=> heart.remove(), 2000);
  }

  // --- Petting ---
  function petCat(cat){
    if(petted.has(cat.id)) return;
    petted.add(cat.id);
    popHeartOverPlayer();
    appendMsg(cat.msg);

    if(petted.size === cats.length){
      // Unlock cue
      door.style.boxShadow = '0 0 0 0 rgba(124,255,184,.6)';
      door.animate([{boxShadow:'0 0 0 0 rgba(124,255,184,.0)'},{boxShadow:'0 0 0 8px rgba(124,255,184,.35)'}],
                   {duration:300, direction:'alternate', iterations:2});
    }
  }
  cats.forEach(c=>{
    document.getElementById(c.id).addEventListener('click', ()=> petCat(c));
  });

  // Door click (still shakes if early; auto-advance handled in loop)
  door.addEventListener('click', ()=>{
    if(petted.size !== cats.length){
      door.animate(
        [{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
        {duration:220, iterations:1}
      );
    }
  });

  // --- Game loop: player control + auto-advance when touching door ---
  function tick(){
    let dx=0, dy=0;
    if(keys.w || keys.ArrowUp)    dy -= speed;
    if(keys.s || keys.ArrowDown)  dy += speed;
    if(keys.a || keys.ArrowLeft)  dx -= speed;
    if(keys.d || keys.ArrowRight) dx += speed;

    if(dx || dy) movePlayer(dx,dy);

    if(petted.size === cats.length && intersects(player, doorRect())){
      window.location.href = NEXT_URL;
      return;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Initial instruction line
  appendMsg('You must pet all three to pass.');
})();
</script>
</body>
</html>
